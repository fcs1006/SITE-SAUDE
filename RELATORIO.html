<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Relat√≥rio SMS</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* CSS MANTIDO */
    :root { --primary-blue: #0056b3; --header-bg: #0b5ed7; --bg-gray: #f8f9fa; --border-color: #dee2e6; }
    body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: transparent; margin: 0; padding: 20px; color: #333; }
    
    /* --- CSS DO CABE√áALHO (ALINHADO √Ä ESQUERDA) --- */
    .header {
      display: flex;
      align-items: center;
      justify-content: flex-start; /* <--- MUDAN√áA AQUI: Alinha √† esquerda */
      border-bottom: 2px solid #eee; 
      padding-bottom: 15px; 
      margin-bottom: 20px;
      gap: 15px; 
      text-align: left;
    }
    .header img { max-height: 70px; width: auto; }
    .header-text { 
        color: var(--primary-blue); font-weight: bold; font-size: 0.9rem; 
        line-height: 1.3; text-transform: uppercase;
    }
    @media (max-width: 600px) {
      .header { flex-direction: column; text-align: center; }
    }
    /* ------------------------------------------------ */

    /* MODAIS */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 10000;
      display: none; justify-content: center; align-items: center;
    }
    .modal-card {
      background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 450px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto;
    }
    
    .form-group { margin-bottom: 12px; }
    label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 12px; color: #555; }
    .modal-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    select.modal-input { background: white; }
    
    .divisor { border-top: 1px solid #eee; margin: 15px 0; position: relative; }
    .divisor span { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: white; padding: 0 10px; color: #999; font-size: 11px; }

    /* Login & Layout Global */
    #telaLogin { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f4f7f6; display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .login-card { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; width: 300px; }
    .login-card input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; }
    .login-card button { width: 100%; padding: 10px; background: var(--header-bg); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }

    .main-container { max-width: 100%; margin: 0 auto; background: white; border-radius: 8px; padding: 20px; } 
    .header-top { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; }
    
    /* Bot√µes */
    .btn { display: flex; align-items: center; gap: 5px; padding: 8px 16px; border-radius: 4px; border: none; font-weight: 500; cursor: pointer; font-size: 14px; text-decoration: none; }
    .btn-print { background-color: #0d6efd; color: white; }
    .btn-edit { background-color: #198754; color: white; } 
    .btn-delete { background-color: #dc3545; color: white; }
    .btn-exit { background-color: white; color: #dc3545; border: 1px solid #dc3545; }
    .btn-secondary { background-color: #6c757d; color: white; }
    .btn-yellow { background-color: #ffc107; color: #000; font-weight: bold; }

    /* Tabela e Filtros */
    .filter-bar { background-color: #f1f3f4; padding: 15px; border-radius: 8px; display: flex; align-items: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .filter-bar input, .filter-bar select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    .table-container { width: 100%; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 11px; table-layout: auto; }
    thead th { background-color: #0056b3; color: white; text-align: left; padding: 8px; font-weight: 600; text-transform: uppercase; white-space: nowrap; }
    tbody tr { background-color: white; border-bottom: 1px solid #dee2e6; }
    tbody td { padding: 6px 8px; color: #212529; vertical-align: top; line-height: 1.3; }
    tbody tr:hover { background-color: #f2f6fc; }

    /* Classes Especiais */
    .col-fixa { white-space: nowrap; width: 1%; }
    .col-acomp { text-align: center; white-space: nowrap; width: 1%; }
    .col-nome { min-width: 120px; max-width: 200px; word-wrap: break-word; }
    .col-destino { min-width: 100px; word-wrap: break-word; }
    .col-obs { min-width: 80px; font-size: 10px; color: #555; word-wrap: break-word; }
    .col-resp { white-space: nowrap; font-size: 10px; }
    .texto-destaque { font-weight: 600; color: #000; }

    @media print {
      .filter-bar, .top-buttons, #telaLogin, .modal-overlay { display: none !important; }
      /* Esconde o bot√£o SAIR do cabe√ßalho na impress√£o */
      .header-sair { display: none !important; }
      
      body { padding: 0; background-color: white; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      .table-container, .main-container { overflow: visible !important; display: block !important; width: 100% !important; height: auto !important; }
      table { width: 100% !important; font-size: 9px; }
      thead { display: table-header-group; }
      thead th { background-color: #0056b3 !important; color: white !important; box-shadow: inset 0 0 0 1000px #0056b3; }
      tr, td { page-break-inside: avoid !important; break-inside: avoid !important; }
    }
  </style>
</head>
<body>

<div id="modalExclusao" class="modal-overlay">
  <div class="modal-card">
    <h3 style="margin-top:0; color:#dc3545; text-align:center;">üóëÔ∏è Excluir Paciente</h3>
    <div class="form-group">
      <label>Nome do Paciente:</label>
      <input type="text" id="excNome" list="listaPacientes" class="modal-input" placeholder="Carregando..." disabled>
      <datalist id="listaPacientes"></datalist>
    </div>
    <div class="form-group">
      <label>Data da Viagem:</label>
      <input type="date" id="excData" class="modal-input">
    </div>
    <div style="display:flex; justify-content:space-between; margin-top:20px;">
      <button class="btn btn-secondary" onclick="fecharModal('modalExclusao')">Fechar</button>
      <button class="btn btn-delete" id="btnConfirmarExcluir" onclick="confirmarExclusao()">EXCLUIR</button>
    </div>
    <div id="statusExclusao" style="text-align:center; margin-top:10px; font-weight:bold;"></div>
  </div>
</div>

<div id="modalEditar" class="modal-overlay">
  <div class="modal-card">
    <h3 style="margin-top:0; color:#198754; text-align:center;">‚úèÔ∏è Editar / Remarcar</h3>
    <p style="font-size:11px; color:#666; text-align:center;">Preencha o Nome e Data Antiga para localizar.</p>

    <div class="form-group">
      <label>Nome do Paciente:</label>
      <input type="text" id="editNome" list="listaPacientesEdit" class="modal-input" placeholder="Carregando..." disabled>
      <datalist id="listaPacientesEdit"></datalist>
    </div>
    <div class="form-group">
      <label>Data ATUAL (Antiga):</label>
      <input type="date" id="editDataAntiga" class="modal-input">
    </div>

    <div class="divisor"><span>NOVOS DADOS</span></div>

    <div class="form-group">
      <label>Nova Data:</label>
      <input type="date" id="editDataNova" class="modal-input">
    </div>
    
    <div class="form-group">
      <label>Novo Hor√°rio:</label>
      <input type="time" id="editHora" class="modal-input">
    </div>

    <div class="form-group">
      <label>Novo Destino:</label>
      <select id="editDestino" class="modal-input">
          <option value="">Selecione...</option>
          <option value="CONCEI√á√ÉO/PALMAS">CONCEI√á√ÉO/PALMAS</option>
          <option value="CONCEI√á√ÉO/PALMAS - CARRO">CONCEI√á√ÉO/PALMAS - CARRO</option>
          <option value="CONCEI√á√ÉO/ARRAIAS">CONCEI√á√ÉO/ARRAIAS</option>
          <option value="CONCEI√á√ÉO/PORTO NACIONAL">CONCEI√á√ÉO/PORTO NACIONAL</option>
          <option value="CONCEI√á√ÉO/PORTO NACIONAL - CARRO">CONCEI√á√ÉO/PORTO NACIONAL - CARRO</option>
          <option value="CONCEI√á√ÉO/DIAN√ìPOLIS">CONCEI√á√ÉO/DIAN√ìPOLIS</option>
          <option value="CONCEI√á√ÉO/CAMPOS BELOS">CONCEI√á√ÉO/CAMPOS BELOS</option>
          <option value="CONCEI√á√ÉO/GURUPI">CONCEI√á√ÉO/GURUPI</option>
      </select>
    </div>

    <div class="form-group">
      <label>Nova Obs (Tipo Viagem):</label>
      <select id="editObs" class="modal-input">
          <option value="">Selecione...</option>
          <option value="IDA E VOLTA">IDA E VOLTA</option>
          <option value="S√ì IDA">S√ì IDA</option>
          <option value="S√ì VOLTA">S√ì VOLTA</option>
          <option value="IDA E VOLTA/ACP 2">IDA E VOLTA/ACP 2</option>
          <option value="S√ì IDA/ACP 2">S√ì IDA/ACP 2</option>
          <option value="S√ì VOLTA/ACP 2">S√ì VOLTA/ACP 2</option>
      </select>
    </div>

    <div class="form-group">
      <label>Nova Obs (Acomp. 2):</label>
      <select id="editObsA2" class="modal-input">
          <option value="">Manter a mesma...</option>
          <option value="IDA E VOLTA/ACP 2">IDA E VOLTA/ACP 2</option>
          <option value="S√ì IDA/ACP 2">S√ì IDA/ACP 2</option>
          <option value="S√ì VOLTA/ACP 2">S√ì VOLTA/ACP 2</option>
      </select>
    </div>

    <div class="form-group">
      <label>Respons√°vel Pela Altera√ß√£o:</label>
      <select id="editResp" class="modal-input" style="font-weight:bold; color:#0b5ed7;">
          <option value="">Selecione...</option>
          <option value="GLEICYANE">GLEICYANE</option>
          <option value="ALSIONY">ALSIONY</option>
          <option value="FERNANDO">FERNANDO</option>
      </select>
    </div>

    <div style="display:flex; justify-content:space-between; margin-top:20px;">
      <button class="btn btn-secondary" onclick="fecharModal('modalEditar')">Fechar</button>
      <button class="btn btn-edit" id="btnConfirmarEdit" onclick="confirmarEdicao()">SALVAR ALTERA√á√ïES</button>
    </div>
    <div id="statusEdit" style="text-align:center; margin-top:10px; font-weight:bold;"></div>
  </div>
</div>

<div id="telaLogin">
  <div class="login-card">
    <h3 style="margin-top:0;">Acesso Restrito</h3>
    <input type="text" id="loginUser" placeholder="Usu√°rio">
    <input type="password" id="loginPass" placeholder="Senha">
    <button onclick="fazerLogin()">ENTRAR</button>
    <div id="msgErro" style="color:red; font-size:12px; margin-top:10px; display:none;">Dados incorretos</div>
  </div>
</div>

<div class="main-container" id="conteudo" style="display:none;">
  
  <div class="header">
    <img src="https://lh3.googleusercontent.com/u/0/d/1uRm9gJZ7sShqkZJSu9w7R7LgQ6PgtPnu" alt="Logomarca">
    <div class="header-text">
      ESTADO DO TOCANTINS<br>PREFEITURA MUNICIPAL DE CONCEI√á√ÉO DO TOCANTINS<br>
      SECRETARIA MUNICIPAL DE SA√öDE<br>FUNDO MUNICIPAL DE SA√öDE
    </div>
    <div class="header-sair" style="margin-left: auto; cursor: pointer; color: red; font-weight: bold; font-size: 12px;" onclick="sair()">[ SAIR ]</div>
  </div>
  <div class="header-top">
    <h2 style="margin:0; color:#0b5ed7;">Relat√≥rio SMS <span style="color:#666; font-size:18px;" id="totalCount">(0)</span></h2>
    <div class="top-buttons" style="display:flex; gap:10px;">
      <button class="btn btn-print" onclick="window.print()"><span class="material-icons">print</span> Imprimir</button>
      <button class="btn btn-edit" onclick="abrirModal('modalEditar')"><span class="material-icons">edit</span> Editar</button>
      <button class="btn btn-delete" onclick="abrirModal('modalExclusao')"><span class="material-icons">delete</span> Excluir</button>
    </div>
  </div>

  <div class="filter-bar">
    <input type="text" id="inputBuscar" placeholder="Buscar..." onkeyup="filtrarTabela()" style="padding:8px; border:1px solid #ccc; border-radius:4px; flex:2;">
    <select id="filtroMes" onchange="filtrarMes()" style="padding:8px; border-radius:4px; border:1px solid #ccc;">
      <option value="">Todos os Meses</option>
      <option value="/01/">Janeiro</option>
      <option value="/02/">Fevereiro</option>
      <option value="/03/">Mar√ßo</option>
      <option value="/04/">Abril</option>
      <option value="/05/">Maio</option>
      <option value="/06/">Junho</option>
      <option value="/07/">Julho</option>
      <option value="/08/">Agosto</option>
      <option value="/09/">Setembro</option>
      <option value="/10/">Outubro</option>
      <option value="/11/">Novembro</option>
      <option value="/12/">Dezembro</option>
    </select>
    <input type="date" id="filtroData" onchange="filtrarData()" style="padding:7px; border-radius:4px; border:1px solid #ccc;">
    <button class="btn btn-yellow" onclick="filtrarHoje()">Hoje</button>
    <button class="btn btn-delete" onclick="limparFiltros()">Limpar</button>
  </div>

  <div class="table-container">
    <table id="tabelaDados">
      <thead>
        <tr>
          <th>Data</th><th>Hora</th><th>Nome</th><th>Destino</th><th>Motivo</th>
          <th>Obs (Tipo)</th><th>Acomp?</th><th>Nome Acomp 1</th><th>Nome Acomp 2</th>
          <th>Obs 2</th><th>Resp.</th>
        </tr>
      </thead>
      <tbody id="tabelaCorpo">
        <tr><td colspan="11" style="text-align:center; padding:30px;">Carregando...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  let todosDados = [];
  let filtroAtivo = null;
  const CREDENCIAIS = { "alsiony": "cko170560", "fernando": "#Caramelo1006", "gleicyane": "cko170560" };

  window.onload = function() { verificarLogin(); };

  function verificarLogin() {
    const u = localStorage.getItem("sms_user");
    const p = localStorage.getItem("sms_pass");
    if(u && p && CREDENCIAIS[u] === p) {
       document.getElementById("telaLogin").style.display = "none";
       document.getElementById("conteudo").style.display = "block";
       carregarDados();
    }
  }

  function fazerLogin() {
    const u = document.getElementById("loginUser").value.toLowerCase().trim();
    const p = document.getElementById("loginPass").value.trim();
    if (CREDENCIAIS[u] && CREDENCIAIS[u] === p) {
       localStorage.setItem("sms_user", u);
       localStorage.setItem("sms_pass", p);
       verificarLogin();
    } else { document.getElementById("msgErro").style.display = "block"; }
  }

  function sair() { localStorage.clear(); location.reload(); }

  function carregarDados() {
    google.script.run
      .withSuccessHandler(dados => { todosDados = dados; renderizarTabela(dados); })
      .buscarDadosRelatorio();
  }

  function renderizarTabela(dados) {
     const tbody = document.getElementById("tabelaCorpo");
     document.getElementById("totalCount").innerText = `(${dados.length})`;
     if (dados.length === 0) { tbody.innerHTML = `<tr><td colspan="11" style="text-align:center;">Nenhum registro encontrado.</td></tr>`; return; }
     let html = "";
     dados.forEach(d => {
       const temAcomp = (d.acomp === "SIM") ? '<span style="color:green; font-weight:bold;">SIM</span>' : '<span style="color:#ccc;">-</span>';
       html += `<tr><td class="col-fixa">${d.data}</td><td class="col-fixa">${d.hora}</td><td class="col-nome texto-destaque">${d.nome}</td><td class="col-destino">${d.destino}</td><td class="col-destino">${d.motivo}</td><td class="col-obs">${d.obs || ''}</td><td class="col-acomp">${temAcomp}</td><td class="col-nome" style="font-size:10px;">${d.nomeA1 || '-'}</td><td class="col-nome" style="font-size:10px;">${d.nomeA2 || '-'}</td><td class="col-obs">${d.obsA2 || '-'}</td><td class="col-resp">${d.resp || ''}</td></tr>`;
     });
     tbody.innerHTML = html;
  }

  // --- GERENCIAMENTO DE MODAIS ---
  function abrirModal(id) {
     const modal = document.getElementById(id);
     modal.style.display = 'flex';
     
     // Carrega lista de nomes se for a primeira vez
     const listaId = (id === 'modalEditar') ? 'listaPacientesEdit' : 'listaPacientes';
     const inputId = (id === 'modalEditar') ? 'editNome' : 'excNome';
     const datalist = document.getElementById(listaId);
     const input = document.getElementById(inputId);

     if (datalist.options.length === 0) {
        input.disabled = true; input.placeholder = "Carregando lista...";
        google.script.run.withSuccessHandler(nomes => {
            nomes.forEach(n => {
                let opt = document.createElement('option');
                opt.value = n;
                datalist.appendChild(opt);
            });
            input.disabled = false; input.placeholder = "Digite o nome...";
        }).getListaNomesBase();
     }
  }

  function fecharModal(id) {
     document.getElementById(id).style.display = 'none';
     // Limpa campos
     if(id === 'modalExclusao') {
         document.getElementById('excNome').value = ""; document.getElementById('excData').value = "";
         document.getElementById('statusExclusao').innerText = "";
         document.getElementById('btnConfirmarExcluir').style.display = 'inline-block';
     } else {
         document.getElementById('editNome').value = ""; document.getElementById('editDataAntiga').value = "";
         document.getElementById('editDataNova').value = ""; document.getElementById('editObs').value = "";
         document.getElementById('editDestino').value = "";
         document.getElementById('editResp').value = ""; 
         document.getElementById('editHora').value = ""; 
         document.getElementById('editObsA2').value = ""; 

         document.getElementById('statusEdit').innerText = "";
         document.getElementById('btnConfirmarEdit').style.display = 'inline-block';
     }
  }

  // --- L√ìGICA DE EXCLUS√ÉO ---
  function confirmarExclusao() {
     const nome = document.getElementById('excNome').value.trim();
     const data = document.getElementById('excData').value;
     const status = document.getElementById('statusExclusao');
     const btn = document.getElementById('btnConfirmarExcluir');
     
     if (!nome || !data) { alert("Preencha Nome e Data!"); return; }
     if (!confirm(`Confirmar exclus√£o de ${nome}?`)) return;

     btn.style.display = 'none'; status.innerText = "Processando..."; status.style.color = "blue";
     
     google.script.run.withSuccessHandler(res => {
         status.innerText = res; status.style.color = "green"; carregarDados();
     }).withFailureHandler(e => {
         status.innerText = "Erro: " + e.message; status.style.color = "red"; btn.style.display = 'inline-block';
     }).excluirRegistroViagem(nome, data);
  }

  // --- L√ìGICA DE EDI√á√ÉO ---
  function confirmarEdicao() {
     const dados = {
        nome: document.getElementById('editNome').value.trim(),
        dataAntiga: document.getElementById('editDataAntiga').value,
        dataNova: document.getElementById('editDataNova').value,
        novoHorario: document.getElementById('editHora').value,
        novoDestino: document.getElementById('editDestino').value,
        novaObs: document.getElementById('editObs').value,
        novaObsA2: document.getElementById('editObsA2').value,
        responsavel: document.getElementById('editResp').value
     };
     
     const status = document.getElementById('statusEdit');
     const btn = document.getElementById('btnConfirmarEdit');

     if (!dados.nome || !dados.dataAntiga || !dados.dataNova || !dados.novoDestino || !dados.responsavel) {
        alert("Preencha todos os campos obrigat√≥rios (incluindo Respons√°vel)."); return;
     }

     if (!confirm("Confirmar altera√ß√µes?")) return;

     btn.style.display = 'none';
     status.innerText = "Salvando altera√ß√µes..."; status.style.color = "blue";

     google.script.run
       .withSuccessHandler(res => {
           status.innerText = res; status.style.color = "green";
           carregarDados();
       })
       .withFailureHandler(e => {
           status.innerText = "Erro: " + e.message; status.style.color = "red";
           btn.style.display = 'inline-block';
       })
       .editarRegistroViagem(dados);
  }

  // --- FILTROS ---
  function verificarBloqueio(origem) { if (filtroAtivo && filtroAtivo !== origem) return true; return false; }
  function filtrarTabela() {
    const input = document.getElementById("inputBuscar");
    if (verificarBloqueio('BUSCA')) { input.value = ""; return; }
    if (input.value === "") { filtroAtivo = null; renderizarTabela(todosDados); return; }
    filtroAtivo = 'BUSCA';
    const termo = input.value.toLowerCase();
    renderizarTabela(todosDados.filter(d => d.nome.toLowerCase().includes(termo) || d.destino.toLowerCase().includes(termo) || d.data.includes(termo)));
  }
  function filtrarMes() {
     const select = document.getElementById("filtroMes");
     if (verificarBloqueio('MES')) { select.value = ""; return; }
     if (select.value === "") { filtroAtivo = null; renderizarTabela(todosDados); return; }
     filtroAtivo = 'MES'; renderizarTabela(todosDados.filter(d => d.data.includes(select.value)));
  }
  function filtrarData() {
     const input = document.getElementById("filtroData");
     if (verificarBloqueio('DATA')) { input.value = ""; return; }
     if (!input.value) { filtroAtivo = null; renderizarTabela(todosDados); return; }
     filtroAtivo = 'DATA'; const p = input.value.split("-");
     renderizarTabela(todosDados.filter(d => d.data === `${p[2]}/${p[1]}/${p[0]}`));
  }
  function filtrarHoje() {
     if (verificarBloqueio('HOJE')) return; filtroAtivo = 'HOJE';
     const hoje = new Date();
     const hStr = `${String(hoje.getDate()).padStart(2,'0')}/${String(hoje.getMonth()+1).padStart(2,'0')}/${hoje.getFullYear()}`;
     renderizarTabela(todosDados.filter(d => d.data === hStr));
     document.getElementById("inputBuscar").placeholder = "Filtro: HOJE ativado...";
  }
  function limparFiltros() { filtroAtivo = null; document.getElementById("inputBuscar").value = ""; document.getElementById("filtroMes").value = ""; document.getElementById("filtroData").value = ""; renderizarTabela(todosDados); }
</script>
</body>
</html>
