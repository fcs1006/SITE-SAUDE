<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle de Viagem - SMS</title>
<style>
    /* --- CSS GERAL (MANTIDO) --- */
    :root { --primary: #0056b3; --secondary: #004494; --success: #28a745; --text-color: #333; --border-radius: 8px; }
    body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: transparent; margin: 0; padding: 20px; display: flex; justify-content: center; color: var(--text-color); font-size: 14px; }
    
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
    
    #telaCarregando { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; z-index: 10000; display: flex; justify-content: flex-start; align-items: center; color: var(--primary); font-weight: bold; font-size: 1.2rem; flex-direction: column; padding-top: 20%; }
    #telaLogin { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #f4f7f6; z-index: 9999; display: none; display: flex; flex-direction: column; align-items: center; }
    
    .login-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 90%; max-width: 350px; text-align: center; position: fixed; top: 50px; }
    .login-box input { width: 100%; padding: 12px; margin-top: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
    .login-box button { width: 100%; padding: 12px; margin-top: 20px; background-color: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
    .erro-login { color: red; font-size: 13px; margin-top: 15px; display: none; }

    .card { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 1000px; box-sizing: border-box; display: none; }
    .header { display: flex; align-items: center; justify-content: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 15px; gap: 15px; text-align: left; }
    .header img { max-height: 70px; width: auto; }
    .header-text { color: var(--primary); font-weight: bold; font-size: 0.9rem; line-height: 1.3; text-transform: uppercase; }
    h2 { color: var(--primary); text-align: center; margin: 0 0 20px 0; font-size: 1.5rem; }
    h3 { background: var(--primary); color: white; padding: 10px 15px; border-radius: 4px; font-size: 1rem; margin: 25px 0 15px 0; font-weight: 600; }

    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 15px; }
    .col-12 { grid-column: span 12; } .col-8 { grid-column: span 8; } .col-6 { grid-column: span 6; }
    .col-4 { grid-column: span 4; } .col-3 { grid-column: span 3; } .col-2 { grid-column: span 2; }
    
    label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem; color: #555; }
    input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.95rem; height: 40px; transition: border-color 0.3s; }
    input[type="date"] {  font-family:'Segoe UI', Roboto, Helvetica, Arial, sans-serif; font-size: 0.95rem;}

    input:focus, select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px rgba(0, 86, 179, 0.2); }

    .container-botao { margin-top: 30px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 10px; }
    button { width: 100%; max-width: 300px; padding: 15px; color: white; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 1.1rem; font-weight: bold; }
    #btnEnviar, #btnSalvarCadastro { background-color: var(--success); }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    #status, #statusCadastro { margin-top: 15px; font-weight: bold; padding: 10px; border-radius: 4px; text-align: center; display: none; width: 100%; max-width: 300px; }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display: none; align-items: center; justify-content: center; z-index: 10001; }
    .modal-overlay.active { display: flex; }
    .modal-box { background: #fff; border-radius: 10px; padding: 24px; max-width: 420px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
    .modal-title { font-size: 1.1rem; font-weight: 700; color: #c0392b; margin: 0 0 12px 0; }
    .modal-message { font-size: 0.95rem; color: #333; margin-bottom: 18px; }
    .modal-actions { display: flex; justify-content: center; gap: 10px; }
    .modal-btn { background-color: var(--primary); color: #fff; border: none; padding: 10px 18px; border-radius: 6px; font-weight: 600; cursor: pointer; }

    .footer-assinatura { margin-top: 40px; text-align: center; width: 100%; }
    .texto-cidade { font-weight: bold; text-transform: uppercase; margin-bottom: 40px; color: #000; }
    .linha-assinatura { width: 60%; margin: 0 auto; border-top: 1px solid #000; padding-top: 5px; font-weight: bold; }

    .tab-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
    .tab-btn { background-color: #e0e0e0; color: #555; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; max-width: 200px; }
    .tab-btn.active { background-color: var(--primary); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

    @media (max-width: 600px) { .header { flex-direction: column; text-align: center; } .grid > div { grid-column: span 12 !important; } .card { padding: 15px; } }

    /* --- IMPRESS√ÉO COMPACTA --- */
    @media print {

  @page {
    size: A4;
    margin: 1cm; /* antes 0.5cm */
  }

  body {
    background-color: white;
    padding: 0;
    margin: 0;
    font-size: 14px; /* antes 13px */
    -webkit-print-color-adjust: exact;
  }

  /* Esconde telas que n√£o imprimem */
  #telaLogin,
  #telaCarregando,
  .tab-container,
  #viewCadastro,
  .container-botao {
    display: none !important;
  }

  #viewAgendamento {
    display: block !important;
  }

  .card {
    display: block !important;
    box-shadow: none;
    border: none;
    padding: 0;
    margin: 0;
    width: 100%;
    max-width: 100%;
  }

  /* Cabe√ßalho */
  .header {
    padding-bottom: 10px;
    margin-bottom: 10px;
    border-bottom: 2px solid #000;
  }

  .header img {
    max-height: 65px; /* antes 60px */
  }

  .header-text {
    font-size: 13px; /* antes 12px */
    line-height: 1.3;
    color: black;
  }

  h2 {
    font-size: 16px;
    margin: 10px 0;
    color: black;
  }

  h3 {
    background-color: #eee !important;
    color: black !important;
    padding: 5px 8px;
    font-size: 14px;
    margin: 10px 0 6px 0;
    border: 1px solid #999;
  }

  /* Grid menos espremido */
  .grid {
    gap: 2px; /* antes 2px */
  }

  label {
    margin-bottom: 2px;
    font-size: 12px;
    font-weight: bold;
    color: black;
  }

  input,
  select {
    padding: 4px 6px; /* antes 1px 3px */
    font-size: 13px;
    height: auto;
    border: 1px solid #000;
  }

  @media print {
  input[type="date"] {
    font-size: 13px;
    font-family: Arial, Helvetica, sans-serif;
  }
}


  /* Assinatura */
  .footer-assinatura {
    margin-top: 20px;
    page-break-inside: avoid;
  }

  .texto-cidade {
    margin-bottom: 25px;
    font-size: 12px;
  }

  .linha-assinatura {
    border-top: 1px solid #000;
    width: 55%;
    font-size: 12px;
    margin: 0 auto;
  }
}

</style>
</head>
<body>

<div id="telaCarregando"><div class="spinner"></div><div>Carregando sistema...</div></div>

<div id="telaLogin">
  <div class="login-box">
    <div style="margin-bottom: 20px;">
        <img src="https://lh3.googleusercontent.com/u/0/d/1uRm9gJZ7sShqkZJSu9w7R7LgQ6PgtPnu" style="max-height: 150px;" alt="Logo">
    </div>
    <h2 style="font-size: 30px; color: #333; border: none;">Acesso Restrito</h2>
    <input type="text" id="loginUser" placeholder="Usu√°rio" autocomplete="off">
    <input type="password" id="loginPass" placeholder="Senha">
    <button onclick="verificarAcesso()">ENTRAR</button>
    <div id="msgErro" class="erro-login"></div>
  </div>
</div>

<div class="card" id="cardPrincipal">
  <div class="header">
    <img src="https://lh3.googleusercontent.com/u/0/d/1uRm9gJZ7sShqkZJSu9w7R7LgQ6PgtPnu" alt="Logomarca">
    <div class="header-text">
      ESTADO DO TOCANTINS<br>PREFEITURA MUNICIPAL DE CONCEI√á√ÉO DO TOCANTINS<br>
      SECRETARIA MUNICIPAL DE SA√öDE<br>FUNDO MUNICIPAL DE SA√öDE
    </div>
    <div style="margin-left: auto; cursor: pointer; color: red; font-weight: bold; font-size: 12px;" onclick="sair()">[ SAIR ]</div>
  </div>

  <div class="tab-container">
    <button type="button" class="tab-btn active" id="tabBtnAgendamento" onclick="abrirAba('agendamento')">AGENDAMENTO</button>
    <button type="button" class="tab-btn" id="tabBtnCadastro" onclick="abrirAba('cadastro')">NOVO CADASTRO</button>
  </div>

  <div id="viewAgendamento">
    <h2>Controle de Viagem</h2>
    <form id="formViagem" onsubmit="event.preventDefault(); enviar();">
      <div class="grid">
        <div class="col-6"><label>Data da Viagem *</label><input type="date" id="data" required></div>
        <div class="col-6"><label>Hora *</label>
          <select id="hora" required>
            <option value="">--:--</option>
            <option value="06:00">06:00</option><option value="06:30">06:30</option>
            <option value="07:00">07:00</option><option value="07:30">07:30</option>
            <option value="08:00">08:00</option><option value="08:30">08:30</option>
            <option value="09:00">09:00</option><option value="09:30">09:30</option>
            <option value="10:00">10:00</option><option value="10:30">10:30</option>
            <option value="11:00">11:00</option><option value="11:30">11:30</option>
            <option value="12:00">12:00</option><option value="12:30">12:30</option>
            <option value="13:00">13:00</option><option value="13:30">13:30</option>
            <option value="14:00">14:00</option><option value="14:30">14:30</option>
            <option value="15:00">15:00</option><option value="15:30">15:30</option>
            <option value="16:00">16:00</option><option value="16:30">16:30</option>
            <option value="17:00">17:00</option><option value="17:30">17:30</option>
            <option value="18:00">18:00</option>
          </select>
        </div>

       
        <div class="col-12"><h3>Dados do Paciente</h3></div>
        <div class="col-6">
          <label>Nome do Paciente *</label>
        <input type="text" id="nome" list="listaNomes" oninput="mascaraNome(this); debouncedBusca(this.value, 'P')" placeholder="Digite 3 letras para buscar..." autocomplete="off" required>
          <datalist id="listaNomes"></datalist>
        </div>
        <div class="col-3"><label>CPF/CNS *</label><input type="text" id="cpf" required oninput="mascaraCpfCns(this)"></div>
        <div class="col-3"><label>Telefone *</label><input type="text" id="telefone" required oninput="mascaraTelefone(this)"></div>


        <div class="col-4"><label>Data Nasc. *</label><input type="text" id="dtNasc" required oninput="mascaraData(this)"></div>
        <div class="col-4"><label>Idade</label><input type="number" id="idade"></div>
        <div class="col-4"><label>Sexo *</label>
          <select id="sexo" required><option value="">--</option><option value="M">M</option><option value="F">F</option></select>
        </div>
        
      
        <div class="col-6"><label>Endere√ßo *</label><input type="text" id="endereco" required oninput="this.value = this.value.toUpperCase()"></div>
        <div class="col-3"><label>Bairro *</label><input type="text" id="bairro" required oninput="this.value = this.value.toUpperCase()"></div>
        <div class="col-3"><label>CEP *</label><input type="text" id="cep" required></div>
        
        <div class="col-4">
          <label>Atualizar cadastro? *</label>
          <select id="atualizarCadastro" required>
            <option value="">-- SELECIONE --</option><option value="SIM">SIM</option><option value="N√ÉO">N√ÉO</option>
          </select>
        </div>
        
        <div class="col-4">
          <label>Tipo de Viagem *</label>
          <select id="obs" required>
            <option value="">-- SELECIONE --</option>
            <option value="IDA E VOLTA">IDA E VOLTA</option>
            <option value="S√ì IDA">S√ì IDA</option>
            <option value="S√ì VOLTA">S√ì VOLTA</option>
          </select>
        </div>

        <div class="col-4">
          <label>Acompanhante? *</label>
          <select id="temAcomp" onchange="toggleAcomp()" required>
            <option value="">-- SELECIONE --</option><option value="N√ÉO">N√ÉO</option><option value="SIM">SIM</option>
          </select>
        </div>

        <div id="secAcomp1" class="col-12" style="display:none;">
          <h3>Acompanhante 1</h3>
          <div class="grid">
             <div class="col-8">
              <label>Nome Acomp 1 *</label>
              <input type="text" id="nomeA1" list="listaNomesA1" oninput="mascaraNome(this); debouncedBusca(this.value, 'A1')" placeholder="Buscar..." autocomplete="off">
              <datalist id="listaNomesA1"></datalist>
              </div>
              <div class="col-4"><label>CPF/CNS *</label><input type="text" id="cpfA1" oninput="mascaraCpfCns(this)"></div>
              <div class="col-4"><label>Telefone *</label><input type="text" id="telA1" oninput="mascaraTelefone(this)"></div>

              
              <div class="col-4"><label>Data Nasc. *</label><input type="text" id="nascA1" oninput="mascaraData(this)"></div>
              <div class="col-4"><label>Sexo *</label>
              <select id="sexoA1"><option value="">--</option><option value="M">M</option><option value="F">F</option></select>
              </div>

              <div class="col-8"><label>Endere√ßo *</label><input type="text" id="endA1" oninput="this.value = this.value.toUpperCase()"></div>
              <div class="col-4"><label>Bairro *</label><input type="text" id="bairA1" oninput="this.value = this.value.toUpperCase()"></div>
          </div>
        </div>

        <div id="secAcomp2" class="col-12" style="display:none;">
          <h3>Acompanhante 2</h3>
          <div class="grid">
            <div class="col-8">
              <label>Nome Acomp 2 *</label>
              <input type="text" id="nomeA2" list="listaNomesA2" oninput="mascaraNome(this); debouncedBusca(this.value, 'A2')" placeholder="Buscar..." autocomplete="off">
                 <datalist id="listaNomesA2"></datalist>
              </div>
              <div class="col-4"><label>CPF/CNS *</label><input type="text" id="cpfA2" oninput="mascaraCpfCns(this)"></div>
              <div class="col-4"><label>Telefone *</label><input type="text" id="telA2" oninput="mascaraTelefone(this)"></div>
              
              <div class="col-4"><label>Data Nasc. *</label><input type="text" id="nascA2" oninput="mascaraData(this)"></div>
              <div class="col-4"><label>Sexo *</label>
                <select id="sexoA2"><option value="">--</option><option value="M">M</option><option value="F">F</option></select>
              </div>
              

              <div class="col-8"><label>Endere√ßo *</label><input type="text" id="endA2" oninput="this.value = this.value.toUpperCase()"></div>
              <div class="col-4"><label>Bairro *</label><input type="text" id="bairA2" oninput="this.value = this.value.toUpperCase()"></div>
              
              <div class="col-12">
                  <label>Tipo de Viagem (Acomp. 2)</label>
                  <select id="obsA2">
                    <option value="">-- SELECIONE --</option> 
                    <option value="IDA E VOLTA/ACP 2">IDA E VOLTA/ACP 2</option>
                    <option value="S√ì IDA/ACP 2">S√ì IDA/ACP 2</option>
                    <option value="S√ì VOLTA/ACP 2">S√ì VOLTA/ACP 2</option>
                  </select>
              </div>
          </div>
        </div>

        <div class="col-12"><h3>Destino e Motivo</h3></div>
        <div class="col-4">
          <label>Destino *</label>
          <select id="destino" required>
            <option value="">-- SELECIONE --</option>
            <option value="CONCEI√á√ÉO/PALMAS">CONCEI√á√ÉO/PALMAS</option>
            <option value="CONCEI√á√ÉO/PALMAS - CARRO">CONCEI√á√ÉO/PALMAS - CARRO</option>
            <option value="PALMAS/CONCEI√á√ÉO">PALMAS/CONCEI√á√ÉO</option>
            <option value="PALMAS/CONCEI√á√ÉO - CARRO">PALMAS/CONCEI√á√ÉO - CARRO</option>
            <option value="CONCEI√á√ÉO/PORTO NACIONAL">CONCEI√á√ÉO/PORTO NACIONAL</option>
            <option value="CONCEI√á√ÉO/PORTO NACIONAL - CARRO">CONCEI√á√ÉO/PORTO NACIONAL - CARRO</option>
            <option value="PORTO NACIONAL/CONCEI√á√ÉO">PORTO NACIONAL/CONCEI√á√ÉO</option>
            <option value="PORTO NACIONAL/CONCEI√á√ÉO - CARRO">PORTO NACIONAL/CONCEI√á√ÉO - CARRO</option>
            <option value="CONCEI√á√ÉO/ARRAIAS">CONCEI√á√ÉO/ARRAIAS</option>
            <option value="ARRAIAS/CONCEI√á√ÉO">ARRAIAS/CONCEI√á√ÉO</option>
            <option value="CONCEI√á√ÉO/DIAN√ìPOLIS">CONCEI√á√ÉO/DIAN√ìPOLIS</option>
            <option value="DIAN√ìPOLIS/CONCEI√á√ÉO">DIAN√ìPOLIS/CONCEI√á√ÉO</option>
            <option value="CONCEI√á√ÉO/CAMPOS BELOS">CONCEI√á√ÉO/CAMPOS BELOS</option>
            <option value="CONCEI√á√ÉO/GURUPI">CONCEI√á√ÉO/GURUPI</option>
          </select>
        </div>
        <div class="col-4">
          <label>Motivo *</label>
          <select id="motivo" required>
            <option value="">-- SELECIONE --</option>
            <option value="CONSULTA">CONSULTA</option>
            <option value="EXAME">EXAME</option>
            <option value="CIRURGIA - INTERNA√á√ÉO">CIRURGIA - INTERNA√á√ÉO</option>
            <option value="RETORNO CIR. - P√ìS OP">RETORNO CIR. - P√ìS OP</option>
            <option value="PER√çCIA M√âDICA">PER√çCIA M√âDICA</option>
            <option value="ALTA HOSPITALAR">ALTA HOSPITALAR</option>
            <option value="CAPACITA√á√ÉO">CAPACITA√á√ÉO</option>
            <option value="ESTUDANTE">ESTUDANTE</option>
            <option value="S√ì RETORNO">S√ì RETORNO</option>
          </select>
        </div>
        <div class="col-4">
          <label>Agendado por: *</label>
          <select id="agendadoPor" required>
            <option value="">-- SELECIONE --</option>
            <option value="GLEICYANE">GLEICYANE</option>
            <option value="FERNANDO">FERNANDO</option>
            <option value="ALSIONY">ALSIONY</option>
          </select>
        </div>
      </div>

      <div class="footer-assinatura">
          <div id="dataImpressao" class="texto-cidade"></div>
          <div class="linha-assinatura">ASSINATURA</div>
      </div>

      <div class="container-botao">
        <button type="submit" id="btnEnviar">GRAVAR NO SISTEMA</button>
        <div id="status"></div>
      </div>
    </form>
  </div>

  <div id="viewCadastro" style="display:none;">
    <h2>Cadastrar Novo Paciente na Base</h2>
    <form id="formCadastro" onsubmit="event.preventDefault(); enviarCadastro();">
      <div class="grid">
        <div class="col-12"><label>Nome Completo (Somente Letras) *</label><input type="text" id="cadNome" required oninput="mascaraNome(this)"></div>
        <div class="col-6"><label>CPF (11) ou CNS (15) *</label><input type="text" id="cadCpf" required maxlength="19" oninput="mascaraCpfCns(this)" onblur="verificarExistencia(this.value)"></div>
        <div class="col-6"><label>Data de Nascimento *</label><input type="text" id="cadNasc" required maxlength="10" placeholder="dd/mm/aaaa" oninput="mascaraData(this); calcularIdadeAuto(this.value)"></div>
        <div class="col-4"><label>Idade</label><input type="number" id="cadIdade" readonly style="background-color: #f0f0f0; font-weight:bold;"></div>
        <div class="col-4"><label>Sexo *</label><select id="cadSexo" required><option value="">--</option><option value="M">M</option><option value="F">F</option></select></div>
        <div class="col-4"><label>Telefone *</label><input type="text" id="cadTelefone" required maxlength="15" oninput="mascaraTelefone(this)"></div>
        <div class="col-4"><label>CEP</label><input type="text" id="cadCep" value="77.305-000" readonly style="background-color: #e9ecef;"></div>
        <div class="col-6"><label>Endere√ßo *</label><input type="text" id="cadEndereco" required oninput="this.value = this.value.toUpperCase()"></div>
        <div class="col-2"><label>N¬∫</label><input type="text" id="cadNumero" value="S/N" readonly style="background-color: #e9ecef; text-align: center;"></div>
      <div class="col-12"><label>Bairro *</label><input type="text" id="cadBairro" required oninput="this.value = this.value.toUpperCase()"></div>
    </div>
      <div class="container-botao" style="flex-direction: row; justify-content: center;">
        <button type="button" onclick="limparCadastro()" style="background-color: #6c757d; margin-right: 10px; max-width: 150px;">LIMPAR</button>
        <button type="submit" id="btnSalvarCadastro" style="max-width: 200px;">SALVAR NA BASE</button>
      </div>
      <div id="statusCadastro" style="margin-top: 10px; text-align: center;"></div>
    </form>
  </div>
</div>

<div id="dupModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="dupModalTitle" aria-describedby="dupModalMessage">
  <div class="modal-box">
    <div id="dupModalTitle" class="modal-title">Aten√ß√£o</div>
    <div id="dupModalMessage" class="modal-message"></div>
    <div class="modal-actions">
      <button type="button" class="modal-btn" onclick="fecharModalDuplicidade()">OK</button>
    </div>
  </div>
</div>

<script>
  const CREDENCIAIS = { "alsiony": "cko170560", "fernando": "#Caramelo1006", "gleicyane": "cko170560" };
  let bancoDeDados = [];
  let pacienteCarregado = false;
  const TEMPO_SESSAO_MINUTOS = 240;

  window.onload = function() {
      const hoje = new Date();
      const dia = String(hoje.getDate()).padStart(2, '0');
      const mes = String(hoje.getMonth() + 1).padStart(2, '0');
      const ano = hoje.getFullYear();
      document.getElementById('dataImpressao').innerText = `CONCEI√á√ÉO DO TOCANTINS-TO, ${dia}/${mes}/${ano}`;
      verificarSessaoSalva();
      setAtualizarCadastroDisponivel(false);
      toggleAcomp(); // Inicia com o estado correto
  };

  // --- M√°scaras ---
  function mascaraNome(input) { input.value = input.value.replace(/[^a-zA-Z\u00C0-\u00FF\s]/g, "").toUpperCase(); }
  function mascaraCpfCns(input) {
    let v = input.value.replace(/\D/g, "");
    if (v.length > 11) { input.maxLength = 19; v = v.replace(/^(\d{3})(\d)/, "$1.$2"); v = v.replace(/^(\d{3})\.(\d{3})(\d)/, "$1.$2.$3"); v = v.replace(/^(\d{3})\.(\d{3})\.(\d{3})(\d)/, "$1.$2.$3.$4"); v = v.replace(/^(\d{3})\.(\d{3})\.(\d{3})\.(\d{3})(\d)/, "$1.$2.$3.$4.$5"); } 
    else { v = v.replace(/(\d{3})(\d)/, "$1.$2"); v = v.replace(/(\d{3})(\d)/, "$1.$2"); v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2"); }
    input.value = v;
  }
  function mascaraData(input) { let v = input.value.replace(/\D/g, ""); v = v.replace(/(\d{2})(\d)/, "$1/$2"); v = v.replace(/(\d{2})(\d)/, "$1/$2"); input.value = v; }
  function mascaraTelefone(input) { let v = input.value.replace(/\D/g, ""); v = v.replace(/^(\d{2})(\d)/g, "($1) $2"); v = v.replace(/(\d)(\d{4})$/, "$1-$2"); input.value = v; }
  function calcularIdadeAuto(dataStr) {
    if (!dataStr || dataStr.length < 10) return;
    const partes = dataStr.split('/'); if (partes.length !== 3) return;
    const diaNasc = parseInt(partes[0]); const mesNasc = parseInt(partes[1]) - 1; const anoNasc = parseInt(partes[2]);
    const hoje = new Date(); const nascimento = new Date(anoNasc, mesNasc, diaNasc);
    let idade = hoje.getFullYear() - nascimento.getFullYear();
    const m = hoje.getMonth() - nascimento.getMonth();
    if (m < 0 || (m === 0 && hoje.getDate() < nascimento.getDate())) idade--;
    if (idade >= 0) document.getElementById('cadIdade').value = idade;
  }

  // --- Fun√ß√µes de Sistema ---
  function verificarExistencia(valor) {
    if (!valor || valor.length < 5) return;
    if (!bancoDeDados || bancoDeDados.length === 0) return;
    const valorLimpo = valor.replace(/\D/g, "");
    const paciente = bancoDeDados.find(p => { const cpfBaseLimpo = p.cpf ? p.cpf.toString().replace(/\D/g, "") : ""; return cpfBaseLimpo === valorLimpo; });
    if (paciente) {
       alert(`PACIENTE J√Å CADASTRADO!\n\nNome: ${paciente.nome}\nData Nasc: ${paciente.nasc}\n\nOs dados ser√£o carregados.`);
       document.getElementById('cadNome').value = paciente.nome; document.getElementById('cadNasc').value = paciente.nasc;
       document.getElementById('cadSexo').value = (paciente.sexo && paciente.sexo.substring(0,1).toUpperCase()) || "";
       document.getElementById('cadTelefone').value = paciente.telefone || ""; document.getElementById('cadEndereco').value = paciente.endereco || "";
       document.getElementById('cadBairro').value = paciente.bairro || ""; calcularIdadeAuto(paciente.nasc);
       mostrarStatus("‚ö†Ô∏è Paciente j√° existe na base!", "erro", "statusCadastro");
    }
  }

  function limparCadastro() { 
      document.getElementById("formCadastro").reset(); 
      document.getElementById("statusCadastro").style.display = 'none'; 
      document.getElementById("cadIdade").value = ""; 
      // N√£o coloca foco para evitar descer a tela
  }
  
  function abrirAba(nomeAba) {
    document.getElementById('viewAgendamento').style.display = 'none'; document.getElementById('viewCadastro').style.display = 'none';
    document.getElementById('tabBtnAgendamento').classList.remove('active'); document.getElementById('tabBtnCadastro').classList.remove('active');
    if (nomeAba === 'agendamento') { document.getElementById('viewAgendamento').style.display = 'block'; document.getElementById('tabBtnAgendamento').classList.add('active'); } 
    else { document.getElementById('viewCadastro').style.display = 'block'; document.getElementById('tabBtnCadastro').classList.add('active'); }
  }
  function verificarSessaoSalva() {
      const userSalvo = localStorage.getItem("sms_user"); const passSalvo = localStorage.getItem("sms_pass"); const timeSalvo = localStorage.getItem("sms_time");
      const agora = new Date().getTime();
      if (userSalvo && passSalvo && timeSalvo && (agora - parseInt(timeSalvo)) / 1000 / 60 < TEMPO_SESSAO_MINUTOS) {
          document.getElementById("loginUser").value = userSalvo; document.getElementById("loginPass").value = passSalvo; verificarAcesso(true); return;
      }
      mostrarLogin();
  }
  function mostrarLogin() { document.getElementById("telaCarregando").style.display = "none"; document.getElementById("telaLogin").style.display = "flex"; localStorage.clear(); }
  function verificarAcesso(isAuto = false) {
      const user = document.getElementById("loginUser").value.toLowerCase().trim(); const pass = document.getElementById("loginPass").value.trim();
      const erro = document.getElementById("msgErro"); const btn = document.querySelector("#telaLogin button");
      if (!isAuto) { btn.innerText = "Entrando..."; btn.disabled = true; erro.style.display = 'none'; }
      if (CREDENCIAIS[user] && CREDENCIAIS[user] === pass) {
          localStorage.setItem("sms_user", user); localStorage.setItem("sms_pass", pass); localStorage.setItem("sms_time", new Date().getTime());
          document.getElementById("telaCarregando").style.display = "none"; document.getElementById("telaLogin").style.display = "none"; document.getElementById("cardPrincipal").style.display = "block";
          if(!isAuto) { mostrarStatus(`Bem-vindo(a), ${user.toUpperCase()}!`, "info", "status"); setTimeout(() => document.getElementById('status').style.display = 'none', 2000); }
          carregarBancoDeDados(user, pass);
      } else { mostrarLogin(); erro.style.display = 'block'; erro.innerText = "Usu√°rio ou senha incorretos!"; if(!isAuto) { btn.innerText = "ENTRAR"; btn.disabled = false; } }
  }
  function carregarBancoDeDados(user, pass) {
      const inputNome = document.getElementById("nome"); inputNome.disabled = true; inputNome.placeholder = "üîÑ Carregando lista...";
      google.script.run.withSuccessHandler(dados => { bancoDeDados = dados; inputNome.disabled = false; inputNome.placeholder = "Digite 3 letras para buscar..."; }).withFailureHandler(err => { console.error("Erro", err); inputNome.placeholder = "Erro ao carregar lista."; }).buscarPacientes(user, pass);
  }
  function sair() { localStorage.clear(); location.reload(); }
  document.getElementById("loginPass").addEventListener("keyup", function(event) { if (event.key === "Enter") verificarAcesso(); });
  let timeoutBusca = null;
  function debouncedBusca(valor, tipo) { clearTimeout(timeoutBusca); timeoutBusca = setTimeout(() => { gerenciarBusca(valor, tipo); }, 300); }
  function gerenciarBusca(valor, tipo) {
    if (!bancoDeDados || bancoDeDados.length === 0) return;
    const idDatalist = tipo === 'P' ? 'listaNomes' : (tipo === 'A1' ? 'listaNomesA1' : 'listaNomesA2');
    const datalist = document.getElementById(idDatalist);
    const pacienteEncontrado = bancoDeDados.find(x => x.nome.toUpperCase() === valor.toUpperCase());
    if (pacienteEncontrado) preencherCampos(pacienteEncontrado, tipo);
    if (tipo === 'P' && !pacienteEncontrado) {
      pacienteCarregado = false;
      setAtualizarCadastroDisponivel(false);
    }
    if (valor.length < 3) { datalist.innerHTML = ''; return; }
    datalist.innerHTML = ''; 
    const sugestoes = bancoDeDados.filter(p => p.nome.toUpperCase().includes(valor.toUpperCase())).slice(0, 10); 
    const fragment = document.createDocumentFragment();
    sugestoes.forEach(p => { let opt = document.createElement('option'); opt.value = p.nome; fragment.appendChild(opt); });
    datalist.appendChild(fragment);
  }
  function preencherCampos(p, tipo) {
    if (tipo === 'P') {
      document.getElementById('cpf').value = p.cpf || ""; document.getElementById('dtNasc').value = p.nasc || ""; 
      document.getElementById('endereco').value = p.endereco || ""; document.getElementById('bairro').value = p.bairro || "";
      document.getElementById('telefone').value = p.telefone || ""; document.getElementById('idade').value = p.idade || "";
      document.getElementById('cep').value = p.cep || ""; document.getElementById('sexo').value = (p.sexo && p.sexo.substring(0,1).toUpperCase()) || "";
      pacienteCarregado = true;
      setAtualizarCadastroDisponivel(true);
    } else if (tipo === 'A1') {
      document.getElementById('cpfA1').value = p.cpf || ""; document.getElementById('nascA1').value = p.nasc || "";
      document.getElementById('endA1').value = p.endereco || ""; document.getElementById('bairA1').value = p.bairro || "";
      document.getElementById('sexoA1').value = (p.sexo && p.sexo.substring(0,1).toUpperCase()) || "";
      document.getElementById('telA1').value = p.telefone || "";
    } else if (tipo === 'A2') {
      document.getElementById('cpfA2').value = p.cpf || ""; document.getElementById('nascA2').value = p.nasc || "";
      document.getElementById('endA2').value = p.endereco || ""; document.getElementById('bairA2').value = p.bairro || "";
      document.getElementById('sexoA2').value = (p.sexo && p.sexo.substring(0,1).toUpperCase()) || "";
      document.getElementById('telA2').value = p.telefone || "";
    }
  }

  // --- L√ìGICA DE VISIBILIDADE DOS ACOMPANHANTES ---
  function toggleAcomp() {
    const temAcomp = document.getElementById('temAcomp').value === "SIM";
    document.getElementById('secAcomp1').style.display = temAcomp ? "block" : "none";
    document.getElementById('secAcomp2').style.display = temAcomp ? "block" : "none";
  }

  function setAtualizarCadastroDisponivel(ativo) {
    const sel = document.getElementById('atualizarCadastro');
    if (!sel) return;
    sel.disabled = !ativo;
    if (!ativo) sel.value = "";
  }

  // --- Fun√ß√£o auxiliar para atribuir 'required' dinamicamente ---
  function setRequired(id, isRequired) {
      const el = document.getElementById(id);
      if(el) {
          if(isRequired) el.setAttribute('required', 'true');
          else el.removeAttribute('required');
      }
  }

  function mostrarStatus(mensagem, tipo, idDiv = 'status') {
      const div = document.getElementById(idDiv); div.style.display = 'block'; div.innerText = mensagem;
      if (tipo === 'erro') { div.style.backgroundColor = '#f8d7da'; div.style.color = '#721c24'; }
      else if (tipo === 'sucesso') { div.style.backgroundColor = '#d4edda'; div.style.color = '#155724'; }
      else { div.style.backgroundColor = '#cce5ff'; div.style.color = '#004085'; }
  }

  function scrollToTop(behavior = 'auto') {
      try {
          document.documentElement.scrollTop = 0;
          document.body.scrollTop = 0;
          window.scrollTo({ top: 0, left: 0, behavior });
      } catch (e) {
          window.scrollTo(0, 0);
      }
  }

  function abrirModalDuplicidade(mensagem) {
    const modal = document.getElementById('dupModal');
    const msgEl = document.getElementById('dupModalMessage');
    const status = document.getElementById('status');
    if (msgEl) msgEl.innerText = mensagem;
    if (status) status.style.display = 'none';
    modal.classList.add('active');
}

function fecharModalDuplicidade() {
    const modal = document.getElementById('dupModal');
    const msgEl = document.getElementById('dupModalMessage');
    modal.classList.remove('active');
    if (msgEl) msgEl.innerText = '';
}

  function enviar() {
    const btn = document.getElementById("btnEnviar");
    const form = document.getElementById('formViagem');
    const temAcomp = document.getElementById("temAcomp").value;
    const nomeA2 = document.getElementById('nomeA2').value.trim(); // Gatilho pelo NOME
    const atualizarCadastro = document.getElementById('atualizarCadastro').value;

    // --- REGRAS DE VALIDA√á√ÉO (BAL√ÉOZINHO NATIVO) ---
    
    // 1. Acompanhante 1: Se SIM, todos obrigat√≥rios
    const isA1 = (temAcomp === "SIM");
    setRequired('nomeA1', isA1); setRequired('cpfA1', isA1); setRequired('nascA1', isA1);
    setRequired('sexoA1', isA1); setRequired('telA1', isA1); setRequired('endA1', isA1); setRequired('bairA1', isA1);

    // 2. Acompanhante 2: Se Tiver Acompanhante (SIM) **E** Nome do Acomp 2 preenchido
    const isA2 = (temAcomp === "SIM" && nomeA2 !== "");
    
    setRequired('cpfA2', isA2); setRequired('nascA2', isA2);
    setRequired('sexoA2', isA2); setRequired('telA2', isA2); setRequired('endA2', isA2); setRequired('bairA2', isA2);
    setRequired('obsA2', isA2);

    // Dispara a valida√ß√£o nativa do navegador
    if (!form.checkValidity()) {
        form.reportValidity(); // Mostra o bal√£o onde falta preencher
        return;
    }
    if (atualizarCadastro === "SIM" && !pacienteCarregado) {
        mostrarStatus("Selecione um paciente da base para atualizar.", "erro", "status");
        return;
    }

    btn.disabled = true; mostrarStatus("Gravando dados...", "info", "status");
    
    const formObj = {
      usuario: localStorage.getItem("sms_user"),
      senha: localStorage.getItem("sms_pass"),
      data: document.getElementById('data').value, hora: document.getElementById('hora').value,
      nome: document.getElementById('nome').value, cpf: document.getElementById('cpf').value, dtNasc: document.getElementById('dtNasc').value,
      sexo: document.getElementById('sexo').value, idade: document.getElementById('idade').value, cep: document.getElementById('cep').value,
      endereco: document.getElementById('endereco').value, bairro: document.getElementById('bairro').value, telefone: document.getElementById('telefone').value,
      atualizarCadastro: document.getElementById('atualizarCadastro').value,
      temAcomp: temAcomp, obs: document.getElementById('obs').value,
      
      nomeA1: document.getElementById('nomeA1').value, cpfA1: document.getElementById('cpfA1').value, nascA1: document.getElementById('nascA1').value,
      endA1: document.getElementById('endA1').value, bairA1: document.getElementById('bairA1').value,
      sexoA1: document.getElementById('sexoA1').value, telA1: document.getElementById('telA1').value,

      nomeA2: document.getElementById('nomeA2').value, cpfA2: document.getElementById('cpfA2').value, nascA2: document.getElementById('nascA2').value,
      endA2: document.getElementById('endA2').value, bairA2: document.getElementById('bairA2').value, obsA2: document.getElementById('obsA2').value,
      sexoA2: document.getElementById('sexoA2').value, telA2: document.getElementById('telA2').value,

      destino: document.getElementById('destino').value, motivo: document.getElementById('motivo').value, agendadoPor: document.getElementById('agendadoPor').value
    };

    google.script.run.withSuccessHandler(res => {
        mostrarStatus("‚úÖ " + res, "sucesso", "status");
        btn.disabled = false;

        const finalizar = () => {
            document.getElementById('formViagem').reset();
            pacienteCarregado = false;
            setAtualizarCadastroDisponivel(false);
            toggleAcomp();
            document.getElementById('status').style.display = 'none';
            scrollToTop('smooth');
        };

        // Em alguns navegadores o window.print() altera a posi√ß√£o do scroll ao fechar o di√°logo.
        // Por isso, fazemos o reset + scroll no evento afterprint.
        window.addEventListener('afterprint', finalizar, { once: true });

        // Garante que inicia no topo antes de imprimir
        scrollToTop('auto');
        setTimeout(() => window.print(), 150);
    }).withFailureHandler(err => {
        const msg = err && err.message ? err.message : String(err);
        if (msg.includes("PACIENTE J√Å CADASTRADO PARA ESTA DATA")) {
            abrirModalDuplicidade(msg);
        } else {
            mostrarStatus("‚ùå Erro: " + msg, "erro", "status");
        }
        btn.disabled = false;
    }).executarCadastroWeb(formObj);
  }

  function enviarCadastro() {
    const btn = document.getElementById("btnSalvarCadastro");
    const formCad = document.getElementById("formCadastro");
    
    // Valida√ß√£o nativa para cadastro
    if (!formCad.checkValidity()) { formCad.reportValidity(); return; }
    
    btn.disabled = true; mostrarStatus("Salvando na base...", "info", "statusCadastro");
    
    const dadosCadastro = {
       usuario: localStorage.getItem("sms_user"), senha: localStorage.getItem("sms_pass"),
       nome: document.getElementById("cadNome").value, cpf: document.getElementById("cadCpf").value, nasc: document.getElementById("cadNasc").value,
       idade: document.getElementById("cadIdade").value, sexo: document.getElementById("cadSexo").value,
       telefone: document.getElementById("cadTelefone").value, cep: document.getElementById("cadCep").value,
       endereco: document.getElementById("cadEndereco").value, bairro: document.getElementById("cadBairro").value,
       numero: document.getElementById("cadNumero").value
    };

    google.script.run.withSuccessHandler(res => {
          mostrarStatus("‚úÖ " + res, "sucesso", "statusCadastro"); btn.disabled = false;
          limparCadastro(); 
          carregarBancoDeDados(dadosCadastro.usuario, dadosCadastro.senha);
          // Rola para o topo DEPOIS de salvar
          window.scrollTo({ top: 0, behavior: 'smooth' });
    }).withFailureHandler(err => { mostrarStatus("‚ùå Erro: " + err.message, "erro", "statusCadastro"); btn.disabled = false; }).salvarNovoPaciente(dadosCadastro);
  }
</script>
</body>
</html>
